# P6 流水线CPU设计草稿

---

### 思考题：

#### Q1：

- 乘除法都有较高的延迟，若整合进ALU，则进行乘除法的时候，所有的运算类指令都只能阻塞在D级，造成了极大的性能损失。单独设置MDU的话，无关的指令还能正常的在ALU运行，效率较高。
- HI，LO寄存器并不是通用寄存器，和其他通用寄存器的用法不一致，不能通过非乘除法指令修改和访问，因此不需要置于GRF中，内置在MDU中即可。

#### Q2：

- 真实的流水线CPU采用的乘法是有加法器和移位器循环，具体实现过程为：

	> 首先CPU会初始化三个通用寄存器用来存放被乘数，乘数，部分积。
	> 部分积寄存器初始化为0。
	> 判断乘数寄存器的低位是0|1，如果为0则将乘数寄存器右移一位，同时将部分积寄存器也右移一位。
	> 在位移时遵循计算机位移规则，乘数寄存器低位溢出的一位丢弃，部分积寄存器低位溢出的一位填充到乘数寄存器的高位。
	> 同时部分积寄存器高位补0。如果为1则将部分积寄存器加上被乘数寄存器，再进行移位操作。
	> 当所有乘数位处理完成后部分积寄存器做高位，乘数寄存器做低位就是最终乘法结果。

- 还有另一种乘法的方式：

	> 只需两个寄存器，A[31:0],B[63:0]，A初始化为被乘数，B初始化为乘数。
	> 每一次取B的最低位，为1则将A[31:0]+B[63:32] -> B[63:32]，为0则不操作。
	> 每次将B >> 1，然后高位补0。

- 除法实现：

	> 与乘法的操作基本相反，首先CPU会初始化三个寄存器,用来存放被除数，除数，部分商。余数(被除数与除数比较的结果)放到被除数的有效高位上。CPU做除法时和做除法时是相反的，乘法是右移，除法是左移，乘法做的是加法，除法做的是减法。首先CPU会把被除数bit位与除数bit位对齐，然后再让对齐的被除数与除数比较(双符号位判断)。比如01-10=11(前面的1是符号位) 1-2=-1 计算机通过符号位和后一位的bit位来判断大于和小于，那么01-10=11 就说明01小于10，如果得数为01就代表大于，如果得数为00代表等于。如果得数大于或等于则将比较的结果放到被除数的有效高位上然后再商寄存器上商：1 并向后多看一位(上商就是将商的最低位左移1位腾出商寄存器最低位上新的商)如果得数小于则上商：0 并向后多看一位然后循环做以上操作当所有的被除数都处理完后，商做结果被除数里面的值就是余数。

#### Q3：

+ `  wire E_stall_MDU = D_is_MDU_opcode & (E_MDU_busy | E_MDU_start);`  

#### Q4：

- 对于需要写入的位置更加的直观，相当于将addr[1:0]用四位字节使能信号表示，十分的统一。

#### Q5：

+ 按字节读写的时候，我们获得的是一字。
+ 若用lb，sb，lh，sh这种非取字的读写时，按字节读可以省去取位，拼接的步骤，效率要优于按字读写。

#### Q6：

+ 见下方 **抽象处理** 和 **MCU**

#### Q7：

- 实现过程见 **HCU** 和 **顶层转发**
- 在常规测试通过后，我们可以将T_rsUse和T_rtUse相同的指令归类为同一需求指令，把T_new相同的指令归类为同一供给指令。
	- 所以可以在new方面有下列指令：add，lw，jal，mfhi
	- 在rsUse方面有下面情况：add，sll，lw，beq，jr，mult，mthi

#### Q8：

- 手动构造策略见上
- 完全随机生成有几大不足之处，如无法保证内存对齐，无法保证延迟槽中没有跳转分支，无法避免一定几率的死循环等等
- 但可以加入策略：
	- 比如只用t0-t6寄存器以保证产生足够多的冲突
	- 在检测到生成跳转后禁用跳转指令
	- 检测到内存不对齐可以不生成等等

---

### 模块设计（乘除单元）：

#### 新增模块：

###### E_MDU:

| 信号            | 方向 | 位宽 | 描述         |
| --------------- | ---- | ---- | ------------ |
| clk             | I    | 1    | 时钟信号     |
| reset           | I    | 1    | 同步复位     |
| start           | I    | 1    | 开始运算信号 |
| CU_MDU_op       | I    | 4    | 功能选择信号 |
| MDU_a           | I    | 32   | 操作数a      |
| MDU_b           | I    | 32   | 操作数b      |
| E_MDU_busy      | O    | 1    | 正在进行信号 |
| E_MDU_out[31:0] | O    | 32   | 输出(HI或LO) |

+ 内置HI、LO两寄存器，E_MDU_out为二者写回寄存器的值
+ 操作数与ALU相同，故命名上不做区分

#### 更改模块/信号：

###### MCU:

| 信号                  | 方向 | 位宽 | 描述                                                         |
| --------------------- | :--- | :--- | :----------------------------------------------------------- |
| CU_MDU_op_D           | O    | 4    | 0000：mult（有符号乘）<br />0001：multu（无符号乘）<br />0010：div（有符号除）<br />0011：divu（无符号除）<br />0100：mfhi（读HI）<br />0101：mflo（读LO）<br />0110：mthi（写HI）<br />0111：mtlo（写LO）<br />1111：非乘除指令 |
| CU_MDU_start_D        | O    | 1    | MDU开始运算信号                                              |
| CU_is_MDU_opcode_D    | O    | 1    | 表示指令为乘除指令                                           |
| CU_GRFWriteData_Sel_D | O    | 2    | 00：选择ALU_out输入<br />01：选择DM_out输入<br />10：选择PC + 8输入<br />11：选择MDU_out输入 |

###### HCU：

| 信号            | 方向 | 位宽 | 描述               |
| --------------- | :--- | :--- | :----------------- |
| D_is_MDU_opcode | I    | 1    | 表示指令为乘除指令 |
| E_MDU_busy      | I    | 1    | MDU输出的busy信号  |
| E_MDU_start     | I    | 1    | MDU输出的start信号 |

###### D_E(ID/EX)：

| 信号           | 方向 | 位宽 | 描述            |
| :------------- | :--- | :--- | :-------------- |
| D_CU_MDU_op    | I    | 4    | MDU_op          |
| D_CU_MDU_start | I    | 1    | MDU开始运算信号 |
| E_CU_MDU_op    | O    | 4    | MDU_op          |
| E_CU_MDU_start | O    | 1    | MDU开始运算信号 |

###### E_M(EX/MEM)：

| 信号      | 方向 | 位宽 | 描述    |
| :-------- | :--- | :--- | :------ |
| E_MDU_out | I    | 32   | MDU_out |
| M_MDU_out | O    | 32   | MDU_out |

###### M_W(MEM/WB)：

| 信号      | 方向 | 位宽 | 描述    |
| :-------- | :--- | :--- | :------ |
| M_MDU_out | I    | 32   | MDU_out |
| W_MDU_out | O    | 32   | MDU_out |

#### 顶层更改：

###### forward_out：

+ E_MDU_out和E_ALU_out回经过选择判断二者谁进行转发

---

### 模块设计（存储器外置）：

#### 新增模块：

###### M_DMIN:

| 信号           | 方向 | 位宽 | 描述                                      |
| -------------- | ---- | ---- | ----------------------------------------- |
| CU_EN_DMWrite  | I    | 1    | 写使能信号                                |
| addr           | I    | 32   | 待操作数据的地址                          |
| writeData      | I    | 32   | 待写入的数据                              |
| CU_DM_op       | I    | 2    | 000: word <br>001: byte <br>010: halfword |
| M_DMIN_out     | O    | 32   | 输出的32位数据                            |
| M_DMIN_byte_en | O    | 4    | 字节使能                                  |

###### M_DMOUT：

| 信号     | 方向 | 位宽 | 描述                                      |
| -------- | ---- | ---- | ----------------------------------------- |
| addr     | I    | 32   | 待操作数据的地址                          |
| readData | I    | 32   | 从外置存储器读出的数据                    |
| CU_DM_op | I    | 2    | 000: word <br>001: byte <br>010: halfword |
| M_DM_out | O    | 32   | 处理后的读出数据                          |

#### 更改模块/信号：

###### F_IFU：

+ 删除 `F_instr`

###### M_DM：

+ 删除

###### D_GRF：

+ 删除 `W_PC`

#### 顶层更改：

###### IM：

| 信号         | 方向 | 位宽 | 描述                                       |
| ------------ | ---- | ---- | ------------------------------------------ |
| i_inst_rdata | I    | 32   | i_inst_addr 对应的 32 位指令               |
| i_inst_addr  | O    | 32   | 需要进行取指操作的流水级 PC（一般为 F 级） |

###### DM：

| 信号          | 方向 | 位宽 | 描述                             |
| ------------- | ---- | ---- | -------------------------------- |
| m_data_rdata  | I    | 32   | 数据存储器存储的相应数据         |
| m_data_addr   | O    | 32   | 待写入/读出的数据存储器相应地址  |
| m_data_wdata  | O    | 32   | 待写入数据存储器相应数据         |
| m_data_byteen | O    | 4    | 四位字节使能（4位对应32位的4段） |
| m_inst_addr   | O    | 32   | M 级 PC                          |

###### GRF：

| 信号        | 方向 | 位宽 | 描述                   |
| ----------- | ---- | ---- | ---------------------- |
| w_grf_we    | O    | 1    | GRF 写使能信号         |
| w_grf_addr  | O    | 5    | GRF 中待写入寄存器编号 |
| w_grf_wdata | O    | 32   | GRF 中待写入数据       |
| w_inst_addr | O    | 32   | W 级 PC                |

---

### 模块设计（增加指令）：

#### 更改模块/信号：

###### E_ALU：

|  信号  | 方向 | 位宽 | 描述                                                         |
| :----: | :--: | :--- | :----------------------------------------------------------- |
| ALU_op |  I   | 4    | 0000：加<br />0001：减<br />0010：或<br />0011：与<br />0100：低位补零<br />0101：slt<br />0110：sltu |

###### D_CMP：

|   信号    | 方向 | 位宽 | 描述           |
| :-------: | :--: | :--- | :------------- |
| CU_CMP_op |  I   | 2    | branch选择信号 |

###### MCU：

|    信号     | 方向 | 位宽 | 描述                                                         |
| :---------: | :--: | :--- | :----------------------------------------------------------- |
| CU_ALU_op_D |  O   | 4    | 0000：加<br />0001：减<br />0010：或<br />0011：与<br />0100：低位补零<br />0101：slt<br />0110：sltu |
| CU_CMP_op_D |  O   | 2    | 00：beq<br />01：bne                                         |

---

### 图表：

##### 控制信号表：

| 指令  | NPC_op | ALU_op | EXT_op | DM_op    | MDU_op | CMP_op | EN_Reg | EN_DM | MDU_start | is_MDU | WriteData | WriteAddr | ALUB |
| ----- | ------ | ------ | ------ | -------- | ------ | ------ | ------ | ----- | --------- | ------ | --------- | --------- | ---- |
| mult  | pc4    | add    | 0      | word     | mult   | 00     | 0      | 0     | 1         | 1      | aluout    | zero      | 0    |
| multu | pc4    | add    | 0      | word     | multu  | 00     | 0      | 0     | 1         | 1      | aluout    | zero      | 0    |
| div   | pc4    | add    | 0      | word     | div    | 00     | 0      | 0     | 1         | 1      | aluout    | zero      | 0    |
| divu  | pc4    | add    | 0      | word     | divu   | 00     | 0      | 0     | 1         | 1      | aluout    | zero      | 0    |
| mfhi  | pc4    | add    | 0      | word     | mfhi   | 00     | 1      | 0     | 0         | 1      | mduout    | rd        | 0    |
| mflo  | pc4    | add    | 0      | word     | mflo   | 00     | 1      | 0     | 0         | 1      | mduout    | rd        | 0    |
| mthi  | pc4    | add    | 0      | word     | mthi   | 00     | 0      | 0     | 0         | 1      | aluout    | zero      | 0    |
| mtlo  | pc4    | add    | 0      | word     | mtlo   | 00     | 0      | 0     | 0         | 1      | aluout    | zero      | 0    |
|       |        |        |        |          |        |        |        |       |           |        |           |           |      |
| lb    | pc4    | add    | 1      | byte     | 1111   | 00     | 1      | 0     | 0         | 0      | dmout     | rt        | 1    |
| lh    | pc4    | add    | 1      | halfword | 1111   | 00     | 1      | 0     | 0         | 0      | dmout     | rt        | 1    |
| sb    | pc4    | add    | 1      | byte     | 1111   | 00     | 0      | 1     | 0         | 0      | aluout    | zero      | 1    |
| sh    | pc4    | add    | 1      | halfword | 1111   | 00     | 0      | 1     | 0         | 0      | aluout    | zero      | 1    |
|       |        |        |        |          |        |        |        |       |           |        |           |           |      |
| and   | pc4    | and    | 0      | word     | 1111   | 00     | 1      | 0     | 0         | 0      | aluout    | rd        | 0    |
| or    | pc4    | or     | 0      | word     | 1111   | 00     | 1      | 0     | 0         | 0      | aluout    | rd        | 0    |
| slt   | pc4    | slt    | 0      | word     | 1111   | 00     | 1      | 0     | 0         | 0      | aluout    | rd        | 0    |
| sltu  | pc4    | sltu   | 0      | word     | 1111   | 00     | 1      | 0     | 0         | 0      | aluout    | rd        | 0    |
| addi  | pc4    | add    | 1      | word     | 1111   | 00     | 1      | 0     | 0         | 0      | aluout    | rt        | 1    |
| andi  | pc4    | and    | 0      | word     | 1111   | 00     | 1      | 0     | 0         | 0      | aluout    | rt        | 1    |
|       |        |        |        |          |        |        |        |       |           |        |           |           |      |
| bne   | branch | add    | 0      | word     | 1111   | 01     | 0      | 0     | 0         | 0      | aluout    | zero      | 0    |



##### AT法表：

| 指令  | T_use_rs | T_use_rt | T_new_D | T_new_E | T_new_M |
| ----- | -------- | -------- | ------- | ------- | ------- |
| mult  | 1        | 1        | ZERO    | ZERO    | ZERO    |
| multu | 1        | 1        | ZERO    | ZERO    | ZERO    |
| div   | 1        | 1        | ZERO    | ZERO    | ZERO    |
| divu  | 1        | 1        | ZERO    | ZERO    | ZERO    |
| mfhi  | MAX      | MAX      | 2       | 1       | 0       |
| mflo  | MAX      | MAX      | 2       | 1       | 0       |
| mthi  | 1        | MAX      | ZERO    | ZERO    | ZERO    |
| mtlo  | 1        | MAX      | ZERO    | ZERO    | ZERO    |
|       |          |          |         |         |         |
| lb    | 1        | MAX      | 3       | 2       | 1       |
| lh    | 1        | MAX      | 3       | 2       | 1       |
| sb    | 1        | 2        | ZERO    | ZERO    | ZERO    |
| sh    | 1        | 2        | ZERO    | ZERO    | ZERO    |
|       |          |          |         |         |         |
| and   | 1        | 1        | 2       | 1       | 0       |
| or    | 1        | 1        | 2       | 1       | 0       |
| slt   | 1        | 1        | 2       | 1       | 0       |
| sltu  | 1        | 1        | 2       | 1       | 0       |
| addi  | 1        | MAX      | 2       | 1       | 0       |
| andi  | 1        | MAX      | 2       | 1       | 0       |
|       |          |          |         |         |         |
| bne   | 0        | 0        | ZERO    | ZERO    | ZERO    |

+ MAX：用3堵死，防止转发
+ ZERO：将 `WriteRegAddr` 设为0，防止向前转发

---

### 抽象处理：

| 类型   | 指令集合                                       | 共有译码部分               |
| ------ | ---------------------------------------------- | -------------------------- |
| CALR   | add、sub、and、or、slt、sltu                   | WriteAddr_sel、            |
| STORE  | sw、sb、sh                                     | EXTop、WriteData_sel       |
| LOAD   | lw、lb、lh                                     | EXTop、WriteAddr_sel       |
| CALI   | ori、lui、addiu、addi、andi                    | WriteAddr_sel、            |
| BRANCH | bne、beq                                       | CU_NPC_op_D                |
| CALDM  | mult、multu、div、divu、mfhi、mflo、mthi、mtlo | is_DMU_opcode、MDU_start、 |

